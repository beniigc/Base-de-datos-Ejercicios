select * from Factura

/* EJERCICIO 7
Generar una consulta que muestre para cada artículo código, detalle, mayor precio
menor precio y % de la diferencia de precios (respecto del menor Ej.: menor precio =
10, mayor precio =12 => mostrar 20 %). Mostrar solo aquellos artículos que posean
stock. */

select prod_codigo, prod_detalle, max (item_precio) maximoPrecio, min(item_precio) minPrecio, convert(numeric(5,2),(((max(item_precio) - min(item_precio)) / min(item_precio)) * 100)) porcentaje
from Producto join Item_Factura on prod_codigo = item_producto join STOCK on stoc_producto = prod_codigo
where stoc_cantidad > 0
group by prod_codigo, prod_detalle
order by prod_codigo

/* Version mejorada */
select prod_codigo, prod_detalle, max (item_precio) maximoPrecio, min(item_precio) minPrecio, convert(numeric(5,2),(((max(item_precio) - min(item_precio)) / min(item_precio)) * 100)) porcentaje
from Producto join Item_Factura on prod_codigo = item_producto
where prod_codigo in (select stoc_producto from STOCK
						where stoc_cantidad > 0)
group by prod_codigo, prod_detalle
order by prod_codigo

/* EJERCICIO 8
Mostrar para el o los artículos que tengan stock en todos los depósitos, nombre del
artículo, stock del depósito que más stock tiene. */

select prod_codigo, prod_detalle, max(stoc_cantidad) DepositoConMasStock
from Producto join Stock on stoc_producto = prod_codigo
group by prod_codigo, prod_detalle
having count(stoc_producto) > (select count(*) from DEPOSITO)


/* EJERCICIO 9
Mostrar el código del jefe, código del empleado que lo tiene como jefe, nombre del
mismo y la cantidad de depósitos que ambos tienen asignados. */

select empl_jefe, empl_codigo, empl_nombre nombreEmpleado, count(*)
from Empleado join DEPOSITO on depo_encargado = empl_codigo or depo_encargado = empl_jefe
group by empl_codigo, empl_jefe, empl_nombre


/* EJERCICIO 10
Mostrar los 10 productos más vendidos en la historia y también los 10 productos menos
vendidos en la historia. Además mostrar de esos productos, quien fue el cliente que
mayor compra realizo. */

select prod_codigo, (select top 1 fact_cliente
					from factura join Item_Factura on item_numero+item_tipo+item_sucursal = fact_numero+fact_tipo+fact_sucursal
					where item_producto = prod_codigo
					group by fact_cliente
					order by sum(item_cantidad) desc)
from Producto 
where (prod_codigo in (select top 10 item_producto
						from Item_Factura join Factura on item_numero+item_tipo+item_sucursal = fact_numero+fact_tipo+fact_sucursal
						group by item_producto
						order by sum(item_cantidad) desc)) 
						or
		(prod_codigo in (select top 10 item_producto
						from Item_Factura join Factura on item_numero+item_tipo+item_sucursal = fact_numero+fact_tipo+fact_sucursal
						group by item_producto
						order by sum(item_cantidad) asc))




select top 10 item_producto, sum(item_cantidad) cantidad
from Item_Factura join Factura on item_numero+item_tipo+item_sucursal = fact_numero+fact_tipo+fact_sucursal
group by item_producto
order by 2 desc

select top 10 item_producto, sum(item_cantidad) cantidad
from Item_Factura join Factura on item_numero+item_tipo+item_sucursal = fact_numero+fact_tipo+fact_sucursal
group by item_producto
order by 2 asc

/* Ejercicio 11
Realizar una consulta que retorne el detalle de la familia, la cantidad diferentes de
productos vendidos y el monto de dichas ventas sin impuestos. Los datos se deberán
ordenar de mayor a menor, por la familia que más productos diferentes vendidos tenga,
solo se deberán mostrar las familias que tengan una venta superior a 20000 pesos para
el año 2012.

ventas sin impuestos = total - total Impuestos, o cantidad * precio 
Hay que traer lo que se vendio en una familia y en el having ver si es superior a 20000 (no puedo poner ahi que sea de 2012)
*/

select fami_detalle, count(item_producto) difProductos, sum (item_cantidad * item_precio)
from Familia left join Producto on prod_familia = fami_id left join Item_Factura on item_producto = prod_codigo 
group by fami_detalle
having fami_detalle in (select fami_detalle 
						from Familia left join Producto on prod_familia = fami_id left join Item_Factura on item_producto = prod_codigo join Factura on item_numero+item_tipo+item_sucursal = fact_numero+fact_tipo+fact_sucursal
						where year(fact_fecha) = 2012 and (item_cantidad * item_precio) > 20000)
order by 2 desc

/* Aca lo hice pensando en que "se deberán mostrar las familias que tengan una venta superior a 20000 pesos para
el año 2012" refiere a que hay algun producto que tenga una venta > 20000, si solo pide que la columna 3 sea > 20000 seria
*/
select fami_detalle, count(distinct(item_producto)) difProductos, sum (item_cantidad * item_precio)
from Familia left join Producto on prod_familia = fami_id left join Item_Factura on item_producto = prod_codigo 
group by fami_detalle
having fami_detalle in (select fami_detalle 
						from Familia left join Producto on prod_familia = fami_id left join Item_Factura on item_producto = prod_codigo join Factura on item_numero+item_tipo+item_sucursal = fact_numero+fact_tipo+fact_sucursal
						where year(fact_fecha) = 2012 
						group by fami_detalle
						having sum((item_cantidad * item_precio)) > 20000)
order by 2 desc

/* EJERCICIO 12
Mostrar nombre de producto, cantidad de clientes distintos que lo compraron, importe
promedio pagado por el producto, cantidad de depósitos en los cuales hay stock del
producto y stock actual del producto en todos los depósitos. Se deberán mostrar
aquellos productos que hayan tenido operaciones en el año 2012 y los datos deberán
ordenarse de mayor a menor por monto vendido del producto.  */

select prod_detalle, count(fact_cliente), avg(item_precio), count(item_producto), sum(stoc_cantidad)
from Producto 
join Item_Factura on item_producto = prod_codigo 
join Factura on item_numero+item_tipo+item_sucursal = fact_numero+fact_tipo+fact_sucursal 
join Stock on stoc_producto = prod_codigo
group by prod_detalle
having prod_detalle in (select prod_detalle	
						from producto join Item_Factura on item_producto = prod_codigo join Factura on item_numero+item_tipo+item_sucursal = fact_numero+fact_tipo+fact_sucursal
						where year(fact_fecha) = 2012)
order by 3

/* en clase */

SELECT prod_detalle, COUNT(distinct(fact_cliente)) '# CLIENTES', AVG(item_precio) 'IMPORTE PRECIO', 
(SELECT COUNT(*)					
FROM Stock
WHERE stoc_producto = prod_codigo and stoc_cantidad > 0),
ISNULL((SELECT SUM(stoc_cantidad)					
FROM Stock
WHERE stoc_producto = prod_codigo 
),0)
FROM Producto JOIN Item_Factura ON item_producto = prod_codigo
JOIN Factura ON item_tipo+item_sucursal+item_numero = fact_tipo+fact_sucursal+fact_numero
WHERE prod_codigo IN
					(SELECT distinct item_producto
					from item_factura
					JOIN Factura ON item_tipo+item_sucursal+item_numero = fact_tipo+fact_sucursal+fact_numero
					WHERE year(fact_fecha) = 2012
					)
GROUP BY prod_codigo, prod_detalle
ORDER BY SUM(item_cantidad * item_precio)


/*13. Realizar una consulta que retorne para cada producto que posea composición nombre
del producto, precio del producto, precio de la sumatoria de los precios por la cantidad
de los productos que lo componen. Solo se deberán mostrar los productos que estén
compuestos por más de 2 productos y deben ser ordenados de mayor a menor por
cantidad de productos que lo componen.*/



/*RESOLUCION */
select p1.prod_detalle, p1.prod_precio, sum(p2.prod_precio*comp_cantidad)  
from composicion join producto p1 on p1.prod_codigo = comp_producto 
join producto p2 on p2.prod_codigo = comp_componente
group by p1.prod_detalle, p1.prod_precio
having count(*) >= 2
order by count(*) DESC




/* 14) Escriba una consulta que retorne una estadística de ventas por cliente. Los campos que
debe retornar son:

Código del cliente
Cantidad de veces que compro en el último año
Promedio por compra en el último año
Cantidad de productos diferentes que compro en el último año
Monto de la mayor compra que realizo en el último año

Se deberán retornar todos los clientes ordenados por la cantidad de veces que compro en
el último año.
No se deberán visualizar NULLs en ninguna columna */

select clie_codigo, count(distinct fact_tipo+fact_sucursal+fact_numero) cantidadDeCompras, convert(numeric(10,2), avg(fact_total)) promedioCompras, count(distinct item_producto) productosDistintosComprados, max(item_cantidad * item_precio) maximaCompra
from Cliente
left join Factura on clie_codigo = fact_cliente and year(fact_fecha) = (select year(max(fact_fecha)) from Factura)
left join Item_Factura on fact_tipo+fact_sucursal+fact_numero = item_tipo+item_sucursal+item_numero
group by clie_codigo
order by 2 desc

/* Aca podriamos hacer un select que ordene por el anio de la fecha de la factura y hacer un top 1 */


/*15. Escriba una consulta que retorne los pares de productos que hayan sido vendidos juntos
(en la misma factura) más de 500 veces. El resultado debe mostrar el código y
descripción de cada uno de los productos y la cantidad de veces que fueron vendidos
juntos. El resultado debe estar ordenado por la cantidad de veces que se vendieron
juntos dichos productos. Los distintos pares no deben retornarse más de una vez.
Ejemplo de lo que retornaría la consulta:
PROD1 DETALLE1 PROD2 DETALLE2 VECES
1731 MARLBORO KS 1 7 1 8 P H ILIPS MORRIS KS 5 0 7
1718 PHILIPS MORRIS KS 1 7 0 5 P H I L I P S MORRIS BOX 10 5 6 2 */

Select p1.prod_codigo, p1.prod_detalle, p2.prod_codigo, p2.prod_detalle, count (*)
from Producto p1 join item_factura I1 on I1.item_producto = p1.prod_codigo 
join item_factura I2 on I2.item_numero + I2.item_sucursal + I2.item_tipo = I1.item_numero + I1.item_sucursal + I1.item_tipo
join Producto p2 on p2.prod_codigo = I2.item_producto and p1.prod_codigo < p2.prod_codigo
group by p1.prod_codigo, p1.prod_detalle, p2.prod_codigo, p2.prod_detalle
having count(*) > 500



/* 16. Con el fin de lanzar una nueva campaña comercial para los clientes que menos compran
en la empresa, se pide una consulta SQL que retorne aquellos clientes cuyas compras
son inferiores a 1/3 del monto de ventas del producto que más se vendió en el 2012.
Además mostrar
1. Nombre del Cliente
2. Cantidad de unidades totales vendidas en el 2012 para ese cliente.
3. Código de producto que mayor venta tuvo en el 2012 (en caso de existir más de 1,
mostrar solamente el de menor código) para ese cliente.

El monto de ventas es cantidad por precio*/

Select clie_codigo, 
(select sum(item_cantidad) from Item_Factura join Factura on item_numero + item_sucursal + item_tipo = fact_numero + fact_sucursal + fact_tipo
where (clie_codigo = fact_cliente and year(fact_fecha) = 2012))
from Cliente join Factura on fact_cliente = clie_codigo
group by clie_codigo
having sum(fact_total) > 
(select sum(item_precio) / 3
from Producto join Item_Factura on item_producto = prod_codigo
where prod_codigo in 
(select top 1 prod_codigo
from Producto left join item_factura on item_producto = prod_codigo join Factura on item_numero + item_sucursal + item_tipo = fact_numero + fact_sucursal + fact_tipo
where year(fact_fecha) = 2012
group by prod_codigo
order by sum(item_cantidad) desc, prod_codigo asc))
						
/* 17) Escriba una consulta que retorne una estadística de ventas por año y mes para cada
producto.

La consulta debe retornar:
PERIODO: Año y mes de la estadística con el formato YYYYMM
PROD: Código de producto
DETALLE: Detalle del producto
CANTIDAD_VENDIDA= Cantidad vendida del producto en el periodo
VENTAS_AÑO_ANT= Cantidad vendida del producto en el mismo mes del periodo
pero del año anterior
CANT_FACTURAS= Cantidad de facturas en las que se vendió el producto en el
periodo*/

select str(year(f1.fact_fecha),4)+right('00'+ltrim(str(Month(f1.fact_fecha),2)),2), prod_codigo, prod_detalle, sum(item_cantidad) CANTIDAD_VENDIDA, 
    (select sum(i2.item_cantidad) from factura f2 join item_factura i2 on f2.fact_tipo+f2.fact_sucursal+f2.fact_numero = i2.item_tipo+i2.item_sucursal+i2.item_numero
    where year(f2.fact_fecha) = year(f1.fact_fecha)-1 and month(f2.fact_fecha) = month(f1.fact_fecha) and prod_codigo = i2.item_producto) VENTAS_AÑO_ANT,
    count(distinct item_tipo+item_sucursal+item_numero) CANT_FACTURAS
from factura f1 join item_factura on f1.fact_tipo+f1.fact_sucursal+f1.fact_numero = item_tipo+item_sucursal+item_numero join Producto on prod_codigo = item_producto
group by year(f1.fact_fecha),Month(f1.fact_fecha), prod_codigo, prod_detalle
order by 1, prod_codigo


select * from Composicion
select * from factura
select * from Item_Factura
select * from producto
select * from DEPOSITO
select * from STOCK
select * from Empleado
select * from Cliente
select * from Producto

/* PRACTICA PARA EL PARCIAL */

/* Sabiendo que si un producto no es vendido en un deposito determinado entonces no posee registros en el 
Se requiere una consulta SQL que para todos los productos que se quedaron sin stock en un deposito (cantidad 0 o nula) y
poseen un stock mayor al punto de resposicion en otro deposito devuelva:

1 - codigo de producto
2 - detalle de producto
3 - domicilio del deposito sin stock
4 - cantidad de depositos con un stock superior al punto de reposicion

la consulta debe ser ordenada por el codigo de producto.
*/

select prod_codigo, prod_detalle, depo_domicilio, count(distinct s2.stoc_deposito)
from Producto
join STOCK s1 on s1.stoc_producto = prod_codigo
join DEPOSITO d1 on d1.depo_codigo = s1.stoc_deposito
join STOCK s2 on s2.stoc_producto = prod_codigo
where (s1.stoc_cantidad = 0 or s1.stoc_cantidad is null) 
        and s2.stoc_cantidad > s2.stoc_punto_reposicion
        and s1.stoc_deposito <> s2.stoc_deposito
group by s1.stoc_producto, prod_codigo, prod_detalle, depo_domicilio
order by 1

select prod_codigo, prod_detalle
from Producto
join STOCK s1 on s1.stoc_producto = prod_codigo
join DEPOSITO d1 on d1.depo_codigo = s1.stoc_deposito
join STOCK s2 on s2.stoc_producto = prod_codigo
order by prod_codigo

select * from Item_factura
select * from Factura

/*
Estadistica de ventas especiales.
La factura es especial si tiene mas de 1 producto con composicion vendido.
Year, cant_fact, total_facturado_especial, porc_especiales, max_factura, monto_total_vendido
Order: cant_fact DESC, monto_total_vendido DESC
*/

Select year(fact_fecha), count(*), sum(item_cantidad * item_precio), (count(*)/(select count(*) from Factura)), max(fact_total), sum(item_cantidad)
From Factura
join Item_factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
where fact_tipo+fact_numero+fact_sucursal in (Select (fact_tipo+fact_numero+fact_sucursal)
												From Factura
												join Item_factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
												where item_producto in (select comp_producto from Composicion)
												group by fact_tipo, fact_numero, fact_sucursal
												having count(*) > 1)
GROUP BY YEAR(fact_fecha);

/*
Realizar una consulta SQL que permita saber si un cliente compor un producto en todos los meses del 2012.
Ademas mostrar para el 2012

1. El cliente
2. La razon social del cliente
3. El producto comprado
4. El nombre del producto
5. Cantidad de productos distintos comprados por el cliente
6. Cantidad de productos con composicion comprados por el cliente

El resultado debera ser ordenado poniendo primero aquellos clientes que compraron mas de 10 productos distintos en el 2012
*/

select clie_codigo, clie_razon_social, item_producto, count(distinct(item_producto)), (select count(*) From Item_Factura 
																						where item_producto in (select comp_producto from Composicion))
From Factura
join Cliente on fact_cliente = clie_codigo
join Item_Factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
where fact_cliente in (select fact_cliente
						from Factura 
						where year(fact_fecha) = '2012' 
						group by fact_cliente
						having (count(distinct(month(fact_fecha))) = 12))
group by clie_codigo, clie_razon_social, item_producto
order by 4 desc

/*
29. Se solicita que realice una estadística de venta por producto para el año 2011, solo para
los productos que pertenezcan a las familias que tengan más de 20 productos asignados
a ellas, la cual deberá devolver las siguientes columnas:
a. Código de producto
b. Descripción del producto
c. Cantidad vendida
d. Cantidad de facturas en la que esta ese producto
e. Monto total facturado de ese producto
Solo se deberá mostrar un producto por fila en función a los considerandos establecidos
antes. El resultado deberá ser ordenado por el la cantidad vendida de mayor a menor.
*/

select prod_codigo, prod_detalle, sum(item_cantidad), count(distinct(fact_tipo+fact_numero+fact_sucursal)), sum(item_cantidad * item_precio)
from producto
Join item_factura on item_producto = prod_codigo
join Factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
where prod_familia in (select top 20 p2.prod_familia
						from Producto p2
						group by p2.prod_familia
						order by count(p2.prod_codigo) desc)
and year(fact_fecha) = '2011'
group by prod_codigo, prod_detalle
order by 4

/* Fijate que trajiste las 20 familias con mas productos asignados no los que tienen mas de veinte */

/* 
31. Escriba una consulta sql que retorne una estadística por Año y Vendedor que retorne las
siguientes columnas:
 Año.
 Codigo de Vendedor
 Detalle del Vendedor
 Cantidad de facturas que realizó en ese año
 Cantidad de clientes a los cuales les vendió en ese año.
 Cantidad de productos facturados con composición en ese año
 Cantidad de productos facturados sin composicion en ese año.
 Monto total vendido por ese vendedor en ese año
Los datos deberan ser ordenados por año y dentro del año por el vendedor que haya
vendido mas productos diferentes de mayor a menor.
*/

select year(fact_fecha), empl_codigo, empl_comision, count(*) as cantidadFacturas , count(distinct(fact_cliente)) as CantidadClientes, sum(fact_total)
(select count(distinct(item_producto))
from item_factura join Factura f2 on item_tipo+item_numero+item_sucursal = f2.fact_tipo+f2.fact_numero+f2.fact_sucursal
where year(f2.fact_fecha) = year(fact_fecha) and item_producto in (select comp_producto from Composicion)) as cantidadCompuestos, 
(select count(distinct(item_producto))
from item_factura join Factura f2 on item_tipo+item_numero+item_sucursal = f2.fact_tipo+f2.fact_numero+f2.fact_sucursal
where year(f2.fact_fecha) = year(fact_fecha) and item_producto not in (select comp_producto from Composicion)) as cantidadNoCompuestos
From Factura
join Empleado on fact_vendedor = empl_codigo
group by year(fact_fecha), empl_codigo, empl_comision
order by 1 desc, (cantidadCompuestos + cantidadNoCompuestos)

/* estaria bueno joinear con item_factura, para poder ponerlo en el order by (count(distinct item_producto)) */


/* 34. Escriba una consulta sql que retorne para todos los rubros la cantidad de facturas mal
facturadas por cada mes del año 2011 Se considera que una factura es incorrecta cuando
en la misma factura se factutan productos de dos rubros diferentes. Si no hay facturas
mal hechas se debe retornar 0. Las columnas que se deben mostrar son:
1- Codigo de Rubro
2- Mes
3- Cantidad de facturas mal realizadas.
*/

select prod_rubro, month(fact_fecha), isnull(count(distinct fact_numero))
From Factura
join Item_Factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
Join producto on item_producto = prod_codigo
where year(fact_fecha) = '2011' and fact_tipo+fact_numero+fact_sucursal in 
(select (f2.fact_tipo+f2.fact_numero+f2.fact_sucursal)
From Factura f2
join Item_Factura I2 on I2.item_tipo+I2.item_numero+I2.item_sucursal = f2.fact_tipo+f2.fact_numero+f2.fact_sucursal
Join producto P2 on I2.item_producto = P2.prod_codigo
group by f2.fact_tipo+f2.fact_numero+f2.fact_sucursal
having (count (P2.prod_rubro) > 1))
group by month(fact_fecha), prod_rubro

select fact_tipo+fact_numero+fact_sucursal
From Factura
join Item_Factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
Join producto on item_producto = prod_codigo
group by fact_tipo+fact_numero+fact_sucursal
having count (prod_rubro) > 1

/*
Realizar una consulta SQL que devuelva para los 5 productos mas vendidos y los 10 productos menos vendidos

- Código y detalle del producto en una sola columna separado por el carácter “–” (ej: 0001 – DETALLE PRODUCTO)
- Nombre del vendedor que más veces vendió el producto.
- Cantidad de depósitos donde hay stock de ese producto.
- Cliente que más veces compró ese producto.
- Monto total facturado al cliente que más compró ese producto.

El resultado deberá mostrarse ordenado de mayor a menor cantidad de ventas de los productos.

NOTA: No se permite el uso de sub-selects en el FROM ni funciones definidas por el usuario para este punto.
*/

--mas vendidos
select CONCAT(prod_codigo +'-', prod_detalle), 
(select top 1 fact_vendedor
From item_factura i2
join Factura f2 on i2.item_tipo+i2.item_numero+i2.item_sucursal = f2.fact_tipo+f2.fact_numero+f2.fact_sucursal
where i2.item_producto = prod_codigo
group by f2.fact_vendedor
order by sum(i2.item_cantidad) desc), 
(select count(distinct(stoc_deposito))
from Stock
where stoc_producto = prod_codigo),
(select top 1 fact_cliente
From Factura
join Item_factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
where item_producto = prod_codigo
group by fact_cliente
order by sum(item_cantidad) desc),
(select sum(fact_total)
from factura
where fact_cliente in (select top 1 fact_cliente
						From Factura
						join Item_factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
						where item_producto = prod_codigo
						group by fact_cliente
						order by sum(item_cantidad) desc))
From Item_Factura
join Factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
join Producto on item_producto = prod_codigo
where item_producto in (select top 5 item_producto	
						from Item_Factura
						join Factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
						group by item_producto
						order by count(distinct(fact_tipo+fact_numero+fact_sucursal)) desc)
group by item_producto, prod_codigo, prod_detalle
UNION 
select CONCAT(prod_codigo +'-', prod_detalle), 
(select top 1 fact_vendedor
From item_factura i2
join Factura f2 on i2.item_tipo+i2.item_numero+i2.item_sucursal = f2.fact_tipo+f2.fact_numero+f2.fact_sucursal
where i2.item_producto = prod_codigo
group by f2.fact_vendedor
order by sum(i2.item_cantidad) desc), 
(select count(distinct(stoc_deposito))
from Stock
where stoc_producto = prod_codigo),
(select top 1 fact_cliente
From Factura
join Item_factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
where item_producto = prod_codigo
group by fact_cliente
order by sum(item_cantidad) desc),
(select sum(fact_total)
from factura
where fact_cliente in (select top 1 fact_cliente
						From Factura
						join Item_factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
						where item_producto = prod_codigo
						group by fact_cliente
						order by sum(item_cantidad) desc))
From Item_Factura
join Factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
join Producto on item_producto = prod_codigo
where item_producto in (select top 10 item_producto	
						from Item_Factura
						join Factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
						group by item_producto
						order by count(distinct(fact_tipo+fact_numero+fact_sucursal)) asc)
group by item_producto, prod_codigo, prod_detalle


/* 1. Realizar una consulta que muestre, para los clientes que compraron 
únicamente en años pares, la siguiente información: 
    - El numero de fila
    - el codigo de cliente
    - el nombre del producto más comprado por el cliente
    - la cantidad total comprada por el cliente en el último año

El resultado debe estar ordenado en función de la cantidad máxima comprada por cliente
de mayor a menor    
*/ 

select f1.fact_cliente, 
(select top 1 prod_detalle
from Factura 
Join item_factura  on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
Join Producto on item_producto = prod_codigo
where fact_cliente = f1.fact_cliente
group by prod_detalle
order by sum(item_cantidad) desc),
(select sum(item_cantidad)
from Factura 
Join item_factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
where f1.fact_cliente = fact_cliente and
year(fact_fecha) = (SELECT MAX(year(fact_fecha)) FROM Factura))
From Factura f1
Join Item_Factura on item_tipo+item_numero+item_sucursal = f1.fact_tipo+f1.fact_numero+f1.fact_sucursal
where (year(f1.fact_fecha) % 2 = 0)
group by f1.fact_cliente
order by sum(item_cantidad) desc


/*
Armar una consulta que muestre para todos los productos:

- Producto
- Detalle del producto
- Detalle composiciOn (si no es compuesto un string SIN COMPOSICION, si es compuesto un string CON COMPOSICION
- Cantidad de Componentes (si no es compuesto, tiene que mostrar 0)
- Cantidad de veces que fue comprado por distintos clientes

Nota: No se permiten sub select en el FROM.
*/

Select prod_codigo, prod_detalle, 
Case
when exists (select comp_componente
			from Composicion
			where comp_producto = prod_codigo)
then 'CON COMPOSICION'
else 'SIN COMPOSICION'
end as detalleComposicion, 
(select isnull(count(comp_componente), 0)
from composicion
where comp_producto = p.prod_codigo),
(select count(distinct(fact_cliente))
From Factura
Join Item_Factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
where item_producto = p.prod_codigo)
From Producto p
left join Composicion on comp_producto = p.prod_codigo

select * from composicion



/* 1. Realizar una consulta SQL que muestre la siguiente informacion para los clientes que hayan
comprado productos en mas de tres rubros diferentes en 2012 y que no compro en años impares   
    - El numero de fila
    - El codigo del cliente 
    - el nombre del cliente
    - la cantidad total comprada por el cliente
    - la categoria en la que más compro en 2012
El resultado debe estar ordenado por la cantidad total comprada de mayor a menor 
*/ 

Select clie_codigo, clie_razon_social, 
(select sum(item_cantidad)
From Factura
join Item_Factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
where fact_cliente = clie_codigo
),
(select top 1 prod_familia
from Factura
join Item_Factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
join Producto on Prod_codigo = item_producto
where fact_cliente = clie_codigo
and year(fact_fecha) = 2012
group by prod_familia
order by count(*))
From Factura f1
join Item_Factura on item_tipo+item_numero+item_sucursal = f1.fact_tipo+f1.fact_numero+f1.fact_sucursal
join Producto on prod_codigo = item_producto
join Cliente on fact_cliente = clie_codigo
where year(f1.fact_fecha) = 2012 and 
not exists (select count(*)
			From Factura
			where year(fact_fecha) % 2 <> 0
			and fact_cliente = f1.fact_cliente)
group by clie_razon_social, clie_codigo
having count(distinct(prod_rubro)) > 2


/* 
1. Consulta SQL para analizar clientes con patrones de compra especificos

Se debe identificar clientes que realizarion una compra inicial y luego volvieron a 
comprar despues de 5 meses o mas 

La consulta debe mostrar 
    - El numero de fila: identificador secuencial del resultado
    - el codigo del cliente id unico del cliente
    - el nombre del cliente: nombre asociado al cliente 
    - cantidad total comprada: total de productos distintos adquiridos por el cliente
    - total facturado: importe total factura al cliente 
El resultado debe estsr ordenado de forma descendente por la cantidad de productos 
adquiridos por cada cliente
*/ 

Select clie_codigo, clie_razon_social, sum(item_cantidad), sum(item_cantidad * item_precio)
From factura f
Join Cliente on clie_codigo = fact_cliente
join item_factura on item_tipo+item_numero+item_sucursal = f.fact_tipo+f.fact_numero+f.fact_sucursal
where exists ( select count(*)
				from Factura f1
				where f1.fact_cliente = clie_codigo
				and f1.fact_tipo+f1.fact_numero+f1.fact_sucursal <> f.fact_tipo+f.fact_numero+f.fact_sucursal
				and DATEDIFF(Month, f1.fact_fecha, f.fact_fecha) > 4)
and not exists ( select count(*)
				from Factura f2
				where f2.fact_cliente = clie_codigo
				and f2.fact_tipo+f2.fact_numero+f2.fact_sucursal <> f.fact_tipo+f.fact_numero+f.fact_sucursal
				and DATEDIFF(Month, f2.fact_fecha, f.fact_fecha) < 4)
group by clie_codigo, clie_razon_social
order by 3 desc



/* Se requiere armar una estadística que retorne para cada año y familia el cliente que menos
 productos diferentes compro y que más monto compro para ese año y familia

Año, Razón Social Cliente, Familia, Cantidad de unidades compradas de esa familia

Los resultados deben ser ordenados por año de menor a mayor y para cada año ordenados por la familia que menos productos 
tenga asignados
NOTA: No se permite el uso de sub-selects en el FROM.*/


Select * from Producto

Select year(fact_fecha), clie_razon_social, prod_familia, sum(item_cantidad)
From Cliente
Join Factura f on f.fact_cliente = clie_codigo
Join item_factura on item_tipo+item_numero+item_sucursal = f.fact_tipo+f.fact_numero+f.fact_sucursal
join Producto on item_producto = prod_codigo
where clie_codigo in (select top 1 clie_codigo
						from Cliente
						Join Factura on clie_codigo = fact_cliente
						join item_factura on item_tipo+item_numero+item_sucursal = fact_tipo+fact_numero+fact_sucursal
						where year(fact_fecha) = year(f.fact_fecha)
						group by clie_codigo
						order by count(distinct(item_producto)) asc, sum(item_cantidad * item_precio) desc)
group by year(f.fact_fecha), clie_razon_social, prod_familia
order by year(f.fact_fecha) asc, 4

-- VERSION CORREGIDA

SELECT year(f.fact_fecha), p.prod_familia, fact_cliente, SUM(item_cantidad) 'Cantidad de unidades vendidas'
FROM Factura f
JOIN Item_Factura ON f.fact_tipo+f.fact_numero+f.fact_sucursal = item_tipo+item_numero+item_sucursal
JOIN Producto p ON item_producto = p.prod_codigo
where fact_cliente = (SELECT TOP 1 FACT_CLIENTE 
    FROM Factura 
    JOIN Item_Factura ON fact_tipo+fact_numero+fact_sucursal = item_tipo+item_numero+item_sucursal
    JOIN Producto p1 ON item_producto = p1.prod_codigo
    JOIN Cliente ON fact_cliente = clie_codigo
    WHERE year(fact_fecha) = year(f.fact_fecha) AND p1.prod_familia = p.prod_familia
    GROUP BY fact_cliente, clie_razon_social
    ORDER BY COUNT(DISTINCT P1.PROD_CODIGO), SUM(item_cantidad * item_precio) desc)
GROUP BY year(f.fact_fecha), p.prod_familia, FACT_CLIENTE
ORDER BY year(f.fact_fecha) asc, (select COUNT(distinct prod_codigo) from producto where prod_familia = p.prod_familia) asc
go 


